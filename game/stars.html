<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf8">
<style>
body {
	background-color: black;
}
* {
	margin: 0; padding: 0;
}
#container {
	position: relative;
	width: 1280px;
	height: 640px;
	background-color: #004;
	margin: 0 auto;
	overflow: hidden;
}
#snv {
	display: none;
	width: 1px;
	height: 1px;
	border-radius: 1px;
	position: absolute;
	-webkit-transform: transformZ(0);
	-webkit-transition: opacity 8s;
	left: 0px;
	top: 0px;
	background-color: #ccf;
	opacity: 1.0;
}
.star {
	-webkit-transform: transformZ(0);
	-webkit-transition: opacity 5s background-color 1s;
	position: absolute;
	width: 1px;
	height: 1px;
	left: 0px;
	top: 0px;
	background-color: #ccf;
}
#cursor {
	position: absolute;
	left: -10px;
	top: -10px;
	width: 20px;
	height: 20px;
	border: 1px solid #eef;
	border-radius: 10px;
	opacity: 0;
}
#action {
	display: none;
	position: absolute;
	top: 0;
	left: 0;
	font-size: 1.2em;
	color: white;
	background-color: black;
}
#text {
	width: 740px;
	height: 100px;
	margin: 200px auto;
	-webkit-transition: opacity 2s;
	color: white;
	text-shadow: black 6px 3px;
	font-family: "tahoma", "arial";
	font-size: 1.5;
	text-transform: uppercase;
	text-align: center;
	line-height: 100px;
	z-index: 10000;
	opacity: 1.0;
}
</style>
<script>
window.onload = function() {
	// helpers
	var setTranslate = function(block) {
		block.data["translate"] = "translate3d(" + block.data.x + "px, " + block.data.y + "px, 0)";
		update(block);
	};
	var setScale = function(block) {
		block.data["scale"] = "scale3d(" + block.data.sx + ", " + block.data.sy + ", 0)";
		update(block);
	};
	var update = function(block) {
		var t = block.data.translate + " " + block.data.scale;
		block.style["-webkit-transform"] = t;
	};

	// define variables
	var lt = 0;
	var stars = [];
	var numRaces = 0;
	var year = 0;
	var timeSpeed = 2;
	var numStars = 3000;
	var state = 0;
	var genocides = 0;
	var container = document.getElementById("container");
	var cursor = document.getElementById("cursor");
	var action = document.getElementById("action");
	var snv = document.getElementById("snv");
	var races = [
		{},
		{color: "#f44", darkColor: "#811", power: 0},
		{color: "#44f", darkColor: "#118", power: 0},
		{color: "#4f4", darkColor: "#181", power: 0},
		{color: "#c90", darkColor: "#740", power: 0}
	];
	var log = function(msg) {
		if(state === 0) {
			console.log("["+parseInt(year)+" CE] "+msg);
		}
	};
	var text = function(msg) {
		var t = document.getElementById("text");
		t.style['height'] = "100px";
		t.innerHTML = msg;
		t.style['opacity'] = 1;
		setTimeout(function() {
			t.style['opacity'] = 0;
		}, 4000);
		setTimeout(function() {
			t.style['height'] = "0px";
		}, 5000);
	};

	log("The universe is born.");
	text("The universe is born.");
	setTimeout(function() {
		text("Click to create, and to destroy.");
	}, 6000);
	setTimeout(function() {
		text("יהוה or Drake?"); 
	}, 12000);
	setTimeout(function() {
		text("(Developer Console has a galactic newsfeed)"); 
	}, 17000);	

	var createStar = function(spawn) {
		var starDiv = document.createElement("div");
		starDiv.classList.add('star');
		var x = spawn.x || Math.random()*1280;
		var y = spawn.y || Math.random()*640;
		var race = spawn.race || 0;
		starDiv['data'] = {
			x: x,
			y: y,
			sx: 1,
			sy: 1,
			translate: "",
			scale: "",
			race: race,
			colTime: 0,
			targetedBy: {},
			colAge: 0
		};
		if(race > 0) {
			log("Created new starfaring civilisation, of race "+race);
		}
		container.appendChild(starDiv);
		setTranslate(starDiv);
		return starDiv;
	};

	// initialise
	var init = function() {
		for(var i=0; i<numStars; i++) {
			//console.log("adding div");
			var star = createStar({});
			stars.push(star);
		}
		// star 0 is home
		var home = stars[0];
		cursor['data'] = {
			x: home.data.x,
			y: home.data.y,
			sx: 1,
			sy: 1,
			translate: "",
			scale: ""
		};
		cursor.animate = function(dt) {
			cursor['data'].sx -= dt*0.001;
			if(cursor['data'].sx < 0.3) {
				cursor['data'].sx = 1;
			}
			cursor['data'].sy = cursor['data'].sx;
			setScale(cursor);
		};
		setTranslate(cursor);
	};

	var findNearestStar = function(params) {
		var dmin = 10000000;
		var current = -1;
		for(var i=0; i<stars.length; i++) {
			if(stars[i].data.dead) {
				continue;
			}
			if(params.notColonized === true && stars[i].data.race > 0) {
				continue;
			}
			if(params.notTargetedBy > 0 && stars[i].data.race === params.notTargetedBy) {
				continue;
			}
			if(params.notTargetedBy > 0 && stars[i].data.targetedBy[params.notTargetedBy]) {
				continue;
			}
			var dx = stars[i].data.x - params.x;
			var dy = stars[i].data.y - params.y;
			var d = dx*dx + dy*dy;
			if(d < dmin) {
				current = i;
				dmin = d;
			}
		}
		if(current >= 0) {
			return {starId: current, dist: dmin};
		}
		return null;
	};

	var setColony = function(id, race) {
		stars[id].style["background-color"] = races[race].color;
		stars[id].data.sx = stars[id].data.sy = 4;
		setScale(stars[id]);
		stars[id].data.colTime = 15000;
		stars[id].data.race = race;
		stars[id].data.colonized = true;
		races[race].power++;
		cursor.style['opacity'] = 0.5;
		cursor.data.x = stars[id].data.x;
		cursor.data.y = stars[id].data.y;
		setTranslate(cursor);
	};

	var verifyStar = function(id, race) {
		if(stars[id].data.dead) {
			if(stars[id].data.blackhole) {
				log("Race "+race+" reached "+id+" but a black hole has formed, swallowing everything forever.");
			} else {
				log("Race "+race+" reached "+id+" but there is nothing there but dust.");
			}
			return false;
		}
		return true;
	};

	var annex = function(id, race) {
		if(!verifyStar(id, race))
			return;
		var r2 = stars[id].data.race;
		var p1 = races[race].power;
		var p2 = races[r2].power;
		if(p1 > p2) {
			log("Race "+race+" annexed colony on "+id+" from race "+r2+"!");
			setColony(id, race);
			races[r2].power--;
			if(races[r2].power === 0) {
				log("Race "+race+" commits genocide against race "+r2+". Will there be a Watcher for the Dead?");
				genocides++;
			}
		} else {
			log("Race "+race+" colony fleet destroyed at destination by race "+r2+".");
		}
	};

	var colonize = function(id, race) {
		if(!verifyStar(id, race))
			return;
		log("Colony fleet of race "+race+" reached "+id+" and settled it.");
		setColony(id, race);
	};

	var tryToColonize = function(i) {
		// find a nearby star to colonize
		var sendShip = function(star) {
			if(star.starId >= 0) {
				stars[i].data.colTime = 5000;
				(function(id, race, dist) {
					var rd = Math.sqrt(dist);
					var travelTime = rd*1500/timeSpeed;
					//var travelTime = dist*50;
					//log("Colonizing "+id+" from "+i+" in "+parseInt(travelTime/1000)+" years.");
					stars[id].data.targetedBy[race] = true;
					stars[id].data.sx = stars[id].data.sy = 3;
					setScale(stars[id]);

					setTimeout(function() {
						// may have been colonized already - check!
						if(stars[id].data.race === 0) {
							colonize(id, race);
						} else {
							annex(id, race);
						}
						stars[id].data.targetedBy[race] = false;
					}, travelTime);
				})(star.starId, stars[i].data.race, star.dist);
			}
		};

		var star = findNearestStar({
			notColonized: true, notTargetedBy: stars[i].data.race, x: stars[i].data.x, y: stars[i].data.y
		});
		if(star) {
			sendShip(star);
		} else {
			// find a inhabited system to expand into if no room is left!
			var star = findNearestStar({
				notTargetedBy: stars[i].data.race, x: stars[i].data.x, y: stars[i].data.y
			});
			if(star) {
				sendShip(star);
			}
		}
	};

	var wipeOutStars = function(x, y, r) {
		for(var i=0; i<stars.length; i++) {
			var dx = stars[i].data.x - x;
			var dy = stars[i].data.y - y;
			if(dx*dx + dy*dy < r*r) {
				log("Star "+i+" annihilated by supernova.");
				if(stars[i].race > 0) {
					races[stars[i].race].power--;
				}
				stars[i].data.dead = true;
				stars[i].style["display"] = "none";
			}
		}
	};

	var updateStars = function(dt) {
		var alive = false;
		for(var i=0; i<stars.length; i++) {
			if(stars[i].data.exploding) {
				stars[i].data.sy += dt*0.0005;
				stars[i].data.sx = stars[i].data.sy;
				setScale(stars[i]);
				snv.data.sy += dt*0.05;
				snv.data.sx = snv.data.sy;
				setScale(snv);
				if(stars[i].data.sy > 3) {
					stars[i].data.exploding = false;
					stars[i].style['opacity'] = 0;
					snv.style['opacity'] = 0;
					wipeOutStars(stars[i].data.x, stars[i].data.y, 100);
				}
			}
			if(stars[i].data.dead) {
				continue;
			}
			if(state === 1) {
				continue;
			}
			alive = true;
			if(stars[i].data.race > 0) {
				if(stars[i].data.colAge < 50000) {
					stars[i].data.colAge += dt;
					stars[i].data.colTime -= dt;
					if(stars[i].data.colTime <= 0) {
						tryToColonize(i);
					}
					if(stars[i].data.colAge > 50000) {
						log("Star system "+i+" falls into decadence and decline. No more colony ships will be built.");
						stars[i].style["background-color"] = races[stars[i].data.race].darkColor;
					}
				}
			}
		}
		if(genocides >= 2 && state === 0) {
			gameover();
		}
		if(!alive && state === 0) {
			gameover();
		}
	};

	var starsAlive = function() {
		for(var i=0; i<stars.length; i++) {
			if(stars[i].data.dead) {}
			else {
				return true;
			}
		}
		return false;
	};

	var gameover = function() {
		var end = function() {
			setTimeout(function() {
				text("Everything seems to be lost. The galaxy has died...");
				setTimeout(function() {
					text("Every last star, destroyed by a supernova in the heat of a million suns...");
				}, 5000);
				setTimeout(function() {
					text("Is this the end?");
				}, 10000);
				setTimeout(function() {
					rebirth();
				}, 15000);
			}, 10000);
		};
		var explode = function(targetStar) {
			targetStar.data.exploding = true;
			targetStar.data.sx = 0.1;
			targetStar.data.sy = 0.1;
			targetStar.style['width'] = "60px";
			targetStar.style['height'] = "60px";
			targetStar.style['top'] = "-30px";
			targetStar.style['left'] = "-30px";
			targetStar.style['border-radius'] = "30px";
			targetStar.data.dead = true;

			snv['data'] = {sx: 3, sy: 3, x: targetStar.data.x, y: targetStar.data.y};
			snv.style['opacity'] = 1.0;
			setTranslate(snv);

			setTimeout(function() {
				if(starsAlive()) {
					var i = Math.random()*stars.length-1;
					var targetStar = stars[parseInt(i)];
					explode(targetStar);
				}
			}, 10);
		};

		var i = Math.random()*stars.length-1;
		var targetStar = stars[parseInt(i)];
		explode(targetStar);
		setTimeout(function() {
			end();
		}, 1000);

		state = 1;
		cursor.style['opacity'] = 0;
	};

	var rebirth = function() {
		var star = createStar({x: 640, y: 320, race: 1});
		setTimeout(function() {
			text("Twinkle, twinkle, little star");
		}, 5000);
		setTimeout(function() {
			text("How I wonder, what you are?");
		}, 10000);
		setTimeout(function() {
			star.style['-webkit-transition'] = "all 25s ease-in";
			star.data.x = 3000;
			star.data.y = 100;
			setTranslate(star);
		}, 15000);
	};

	var animate = function(t) {
		var dt = t-lt;
		lt = t;
		year += (dt/1000)*timeSpeed;
		requestAnimationFrame(animate);
		cursor.animate(dt);
		updateStars(dt);
	}
	var click = function(e) {
		console.log(e.target);
		if(e.target.id !== "container") {
			return;
		}
		var x = e.offsetX;
		var y = e.offsetY;
		if(numRaces < races.length-1) {
			var race = ++numRaces;
			var star = createStar({x: x, y: y, race: race});
			stars.push(star);
			setColony(stars.length-1, race);
		} else if(!targetStar) {
			// do something bad.
			var star = findNearestStar({x: x, y: y});
			if(star) {
				var s = stars[star.starId];
				targetStar = s;
				action.style['display'] = "block";
				action.style['top'] = parseInt(s.data.y)+"px";
				action.style['left'] = parseInt(s.data.x)+"px";
				action.value = "choose";
			}
		}
	};

	if("ontouchstart" in window) {
		container.addEventListener("touchstart", function(e) {
			click(e);
		});
	} else {
		container.onclick = click;
	}
	var targetStar;
	action.onchange = function(e) {
		doAction(this.value);
		e.preventDefault();
		action.style['display'] = "none";
		targetStar = null;
	};
	var doAction = function(action) {
		if(action === "supernova") {
			if(snv.style['opacity'] != 0) {
				return log("Supernova already in progress! Don't be such a sadist...");
			}

			targetStar.data.exploding = true;
			targetStar.data.sx = 0.1;
			targetStar.data.sy = 0.1;
			targetStar.style['width'] = "60px";
			targetStar.style['height'] = "60px";
			targetStar.style['top'] = "-30px";
			targetStar.style['left'] = "-30px";
			targetStar.style['border-radius'] = "30px";
			targetStar.data.dead = true;
			snv.style['display'] = "block";
			snv['data'] = {sx: 3, sy: 3, x: targetStar.data.x, y: targetStar.data.y};
			snv.style['opacity'] = 1.0;
			setTranslate(snv);
		} else if (action === "blackhole") {
			targetStar.data.blackhole = true;
			targetStar.data.dead = true;
			targetStar.data.sx = 3;
			targetStar.data.sy = 3;
			setScale(targetStar);
			targetStar.style['background-color'] = "#000";
		}
	};

	init();
	animate(0);
}
</script>
</head>
<body>
<div id="container">
	<div id="snv"></div>
	<div id="cursor"></div>
	<select id="action">
		<option value="choose">Choose Action:</option>
		<option value="supernova">Supernova</option>
		<option value="blackhole">Black hole</option>
		<option value="cancel">Cancel</option>
	</select>
	<div id="text"></div>
</div>
</div>
</body>
</html>